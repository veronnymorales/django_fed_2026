<style>
  #tabla-variables-detallado {
    width: 100% !important;
    font-size: 11px;
  }

  .dataTables_wrapper {
    padding: 0;
  }

  .table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(0, 0, 0, 0.02);
  }

  .dtrg-group {
    background-color: #ffffff !important; /* Blanco */
    color: #343a40 !important; /* Texto negro/oscuro */
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border-bottom: 2px solid #dee2e6; /* Borde para separar visualmente */
  }

  .dtrg-group:hover {
    background-color: #f8f9fa !important; /* Gris muy claro al hover */
    transform: translateX(2px);
  }

  .dtrg-level-0 {
    background-color: #ffffff !important;
  }

  .number-cell {
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  .percent-cell {
    text-align: right;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    padding: 6px 10px !important;
    border-radius: 4px;
  }

  /* Colores para porcentajes con FONDO (solo 1T %) */
  .percent-bg-low {
    background-color: #ff6b6b !important;
    color: white !important;
  }

  .percent-bg-medium {
    background-color: #ffd93d !important;
    color: #333 !important;
  }

  .percent-bg-high {
    background-color: #6bcf7f !important;
    color: white !important;
  }

  /* Colores para porcentajes SOLO TEXTO (2T % y 3T %) */
  .percent-text-low {
    color: #ff6b6b !important;
    font-weight: 700;
  }

  .percent-text-medium {
    color: #ff8c00 !important;
    font-weight: 700;
  }

  .percent-text-high {
    color: #28a745 !important;
    font-weight: 700;
  }

  /* Remover color de fondo de filas de datos normales */
  #tabla-variables-detallado tbody tr:not(.dtrg-group) {
    background-color: transparent !important;
  }

  .table-striped tbody tr:nth-of-type(odd):not(.dtrg-group) {
    background-color: rgba(0, 0, 0, 0.01) !important;
  }
</style>

<div class="card">
  <div class="card-header">
    <h3 class="card-title">
      <i class="fas fa-layer-group mr-2"></i>RANKING POR ESTABLECIMIENTO
    </h3>
    <div class="card-tools">
      <button
        type="button"
        class="btn btn-tool btn-sm"
        id="btn-expandir-todo-dt"
        data-toggle="tooltip"
        title="Expandir todos"
      >
        <i class="fas fa-expand-arrows-alt"></i> Expandir
      </button>
      <button
        type="button"
        class="btn btn-tool btn-sm ml-1"
        id="btn-colapsar-todo-dt"
        data-toggle="tooltip"
        title="Colapsar todos"
      >
        <i class="fas fa-compress-arrows-alt"></i> Colapsar
      </button>
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table
        id="tabla-variables-detallado"
        class="table table-sm table-hover table-head-fixed text-nowrap"
        style="width: 100%"
      >
        <thead>
          <tr>
            <th>Red</th>
            <th>MicroRed</th>
            <th>Establecimiento</th>
            <th>Den</th>
            <th class="text-center">1¬∞ Trim</th>
            <th class="text-center">1T %</th>
            <th class="text-center">2¬∞ Trim</th>
            <th class="text-center">2T %</th>
            <th class="text-center">3¬∞ Trim</th>
            <th class="text-center">3T %</th>
          </tr>
        </thead>
        <tbody id="tabla-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  let tablaInstance = null;

  // Funci√≥n para aplicar colores CON FONDO (solo para 1T %)
  function applyPercentColorWithBg(td, cellData) {
    const percentValue = parseFloat(cellData);
    if (isNaN(percentValue)) return;

    const decimalValue = percentValue / 100;

    if (decimalValue < 0.7) {
      $(td).addClass("percent-bg-low");
    } else if (decimalValue >= 0.7 && decimalValue < 0.82) {
      $(td).addClass("percent-bg-medium");
    } else if (decimalValue >= 0.82) {
      $(td).addClass("percent-bg-high");
    }
  }

  // Funci√≥n para aplicar colores SOLO TEXTO (para 2T % y 3T %) - L√ìGICA INVERSA
  function applyPercentColorTextOnly(td, cellData) {
    const percentValue = parseFloat(cellData);
    if (isNaN(percentValue)) return;

    const decimalValue = percentValue / 100;

    // L√ìGICA INVERSA: Menor porcentaje = Verde (mejor), Mayor porcentaje = Rojo (peor)
    if (decimalValue < 0.2) {
      $(td).addClass("percent-text-high"); // Verde
    } else if (decimalValue >= 0.2 && decimalValue < 0.5) {
      $(td).addClass("percent-text-medium"); // Naranja
    } else if (decimalValue >= 0.5) {
      $(td).addClass("percent-text-low"); // Rojo
    }
  }

  window.renderTablaVariablesDetallado = function (data, params) {
    console.log("üéØ Renderizando DataTables con agrupaci√≥n", data);
    console.log("üîç Claves disponibles en data:", Object.keys(data));
    console.log("üìä detallado_anio length:", data.detallado_anio?.length);
    console.log("üìä detallado_Red:", data.detallado_Red);

    const dataLength = data.detallado_anio?.length || 0;
    console.log("üìè dataLength calculado:", dataLength);

    if (dataLength === 0) {
      console.warn("‚ö†Ô∏è No hay datos para mostrar en la tabla");
      $("#tabla-variables-detallado tbody").html(
        '<tr><td colspan="10" class="text-center text-muted">No hay datos para mostrar</td></tr>'
      );
      return;
    }

    // Destruir tabla anterior si existe
    if (tablaInstance) {
      tablaInstance.destroy();
      $("#tabla-variables-detallado tbody").empty();
    }

    // Los filtros se aplican en el backend, no necesitamos filtrar aqu√≠
    console.log("üìä Datos recibidos del backend:", dataLength, "registros");

    // Preparar datos con porcentaje num√©rico para ordenar
    const tableData = [];
    for (let i = 0; i < dataLength; i++) {
      if (!data.detallado_anio[i]) continue;

      const rowRed = data.detallado_Red?.[i] || "";
      const rowMicroRed = data.detallado_MicroRed?.[i] || "";
      const rowEstablecimiento =
        data.detallado_Nombre_Establecimiento?.[i] || "";

      const avg1trim =
        data.detallado_avance_1trim?.[i] != null
          ? data.detallado_avance_1trim[i]
          : 0;

      tableData.push([
        rowRed,
        rowMicroRed,
        rowEstablecimiento,
        data.detallado_den_variable?.[i] || "",
        data.detallado_num_1trim?.[i] || 0,
        data.detallado_avance_1trim?.[i] != null
          ? data.detallado_avance_1trim[i].toFixed(1) + "%"
          : "0.0%",
        data.detallado_num_2trim?.[i] || 0,
        data.detallado_avance_2trim?.[i] != null
          ? data.detallado_avance_2trim[i].toFixed(1) + "%"
          : "0.0%",
        data.detallado_num_3trim?.[i] || 0,
        data.detallado_avance_3trim?.[i] != null
          ? data.detallado_avance_3trim[i].toFixed(1) + "%"
          : "0.0%",
        avg1trim, // Columna 10: 1T% individual
      ]);
    }

    // Calcular el promedio de 1T% para cada RED
    const redAverages = {};
    for (let row of tableData) {
      const red = row[0];
      const percent = row[10];

      if (!redAverages[red]) {
        redAverages[red] = { sum: 0, count: 0 };
      }
      redAverages[red].sum += percent;
      redAverages[red].count++;
    }

    // Calcular promedios finales
    for (let red in redAverages) {
      redAverages[red].avg = redAverages[red].sum / redAverages[red].count;
    }

    console.log("üìä Promedios por RED:", redAverages);

    // Agregar el promedio de RED a cada fila (columna 11)
    for (let row of tableData) {
      const red = row[0];
      row.push(redAverages[red].avg); // Columna 11: Promedio de la RED
    }

    // Ordenar primero por promedio de RED descendente, luego por 1T% individual descendente
    tableData.sort((a, b) => {
      // Primero ordenar por promedio de RED (descendente - mayor a menor)
      const avgDiff = b[11] - a[11];
      if (avgDiff !== 0) return avgDiff;

      // Si tienen el mismo promedio de RED, ordenar por 1T% individual descendente
      return b[10] - a[10];
    });

    console.log(
      "üìä Filas ordenadas por promedio de RED (mayor a menor):",
      tableData.length
    );

    // Cargar RowGroup din√°micamente si no est√° cargado
    const loadRowGroup = new Promise((resolve) => {
      if ($.fn.DataTable && $.fn.DataTable.RowGroup) {
        resolve();
      } else {
        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href =
          "https://cdn.datatables.net/rowgroup/1.4.1/css/rowGroup.bootstrap4.min.css";
        document.head.appendChild(link);

        const script = document.createElement("script");
        script.src =
          "https://cdn.datatables.net/rowgroup/1.4.1/js/dataTables.rowGroup.min.js";
        script.onload = resolve;
        document.head.appendChild(script);
      }
    });

    loadRowGroup.then(() => {
      tablaInstance = $("#tabla-variables-detallado").DataTable({
        data: tableData,
        columns: [
          { title: "Red", visible: true },
          { title: "MicroRed", visible: true },
          { title: "Establecimiento", visible: true },
          { title: "Den", visible: true },
          { title: "1¬∞ Trim", className: "number-cell", visible: true },
          {
            title: "1T %",
            className: "percent-cell",
            visible: true,
            createdCell: function (td, cellData, rowData, row, col) {
              applyPercentColorWithBg(td, cellData);
            },
          },
          { title: "2¬∞ Trim", className: "number-cell", visible: true },
          {
            title: "2T %",
            className: "percent-cell",
            visible: true,
            createdCell: function (td, cellData, rowData, row, col) {
              applyPercentColorTextOnly(td, cellData);
            },
          },
          { title: "3¬∞ Trim", className: "number-cell", visible: true },
          {
            title: "3T %",
            className: "percent-cell",
            visible: true,
            createdCell: function (td, cellData, rowData, row, col) {
              applyPercentColorTextOnly(td, cellData);
            },
          },
          {
            title: "Avg1T",
            visible: false,
            searchable: false,
          },
          {
            title: "RedAvg",
            visible: false,
            searchable: false,
          },
        ],
        columnDefs: [
          {
            targets: [10, 11],
            visible: false,
            searchable: false,
          },
        ],
        order: [
          [11, "desc"], //  Promedio de RED descendente (mayor primero)
          [10, "desc"], // 1T% individual descendente
        ],
        paging: false,
        searching: false,
        lengthChange: false,
        info: false,
        responsive: true,
        language: {
          info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
          infoEmpty: "Mostrando 0 registros",
          infoFiltered: "(filtrado de _MAX_ registros)",
          paginate: {
            first: "Primero",
            last: "√öltimo",
            next: "Siguiente",
            previous: "Anterior",
          },
        },
        rowGroup: {
          dataSrc: [0], // Agrupar solo por Red
          startRender: function (rows, group, level) {
            const groupLabel = "RED";
            const icon = '<i class="fas fa-plus-circle mr-2"></i>';

            // El promedio ya est√° calculado, tomarlo de la primera fila del grupo
            const avgPercent = rows.data()[0][11].toFixed(1);

            // Determinar color de la barra seg√∫n el porcentaje (estilo Admin LTE)
            let progressColor = "bg-danger";
            if (avgPercent >= 82) {
              progressColor = "bg-success";
            } else if (avgPercent >= 70) {
              progressColor = "bg-warning";
            }

            // Contenedor Flex para alinear: Izquierda (Info) - Derecha (Progreso)
            const contentHTML = `
              <div class="d-flex justify-content-between align-items-center w-100">
                <div class="d-flex align-items-center">
                  ${icon}
                  <span class="mr-1">${groupLabel}:</span>
                  <strong class="mr-2">${group}</strong>
                  <span class="badge badge-light">${rows.count()}</span>
                </div>

                <div class="d-flex align-items-center" style="width: 350px;">
                  <small class="text-dark mr-2 text-nowrap">Avance %:</small>
                  <div class="progress flex-fill mx-2" style="height: 20px; background-color: rgba(0,0,0,0.1);">
                    <div class="progress-bar ${progressColor}"
                         role="progressbar"
                         style="width: ${Math.min(avgPercent, 100)}%"
                         aria-valuenow="${avgPercent}"
                         aria-valuemin="0"
                         aria-valuemax="100">
                      <span style="font-size: 11px; font-weight: bold; color: ${
                        progressColor === "bg-warning" ? "#333" : "white"
                      };">${avgPercent}%</span>
                    </div>
                  </div>
                </div>
              </div>
            `;

            return $("<tr/>")
              .addClass("dtrg-group dtrg-level-0")
              .append($('<td colspan="12">').html(contentHTML))
              .attr("data-group", group)
              .attr("data-level", 0);
          },
        },
      });

      // Eventos de expandir/colapsar
      $("#tabla-variables-detallado tbody").on(
        "click",
        "tr.dtrg-group",
        function () {
          const icon = $(this).find("i");

          // Cambiar icono
          if (icon.hasClass("fa-minus-circle")) {
            icon.removeClass("fa-minus-circle").addClass("fa-plus-circle");
          } else {
            icon.removeClass("fa-plus-circle").addClass("fa-minus-circle");
          }

          const groupName = $(this).attr("data-group");
          const rows = tablaInstance
            .rows()
            .nodes()
            .to$()
            .filter(function () {
              return (
                $(this).find("td:first").text() === groupName &&
                !$(this).hasClass("dtrg-group")
              );
            });

          rows.toggle();
        }
      );

      // Expandir todo
      $("#btn-expandir-todo-dt").on("click", function () {
        $("tr.dtrg-group i")
          .removeClass("fa-plus-circle")
          .addClass("fa-minus-circle");
        tablaInstance.rows().nodes().to$().show();
      });

      // Colapsar todo
      $("#btn-colapsar-todo-dt").on("click", function () {
        $("tr.dtrg-group i")
          .removeClass("fa-minus-circle")
          .addClass("fa-plus-circle");
        tablaInstance
          .rows()
          .nodes()
          .to$()
          .filter(function () {
            return !$(this).hasClass("dtrg-group");
          })
          .hide();
      });

      console.log("‚úÖ Tabla renderizada con √©xito");

      // Colapsar autom√°ticamente al inicio
      setTimeout(() => {
        $("tr.dtrg-group i")
          .removeClass("fa-minus-circle")
          .addClass("fa-plus-circle");
        tablaInstance
          .rows()
          .nodes()
          .to$()
          .filter(function () {
            return !$(this).hasClass("dtrg-group");
          })
          .hide();
        console.log("üìÅ Tabla colapsada autom√°ticamente");
      }, 100);
    });
  };
</script>
