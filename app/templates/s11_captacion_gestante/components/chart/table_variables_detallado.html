<style>
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ESTILOS PRINCIPALES DE LA TABLA
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  #tabla-variables-detallado {
    width: 100% !important;
    font-size: 11px;
  }

  .dataTables_wrapper {
    padding: 0;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     Estilos de filas alternadas
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

  .table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(0, 0, 0, 0.02);
  }

  #tabla-variables-detallado tbody tr:not(.dtrg-group) {
    background-color: transparent !important;
  }

  .table-striped tbody tr:nth-of-type(odd):not(.dtrg-group) {
    background-color: rgba(0, 0, 0, 0.01) !important;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     Estilos de grupos (RowGroup)
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

  .dtrg-group {
    background-color: #ffffff !important;
    color: #343a40 !important;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    border-bottom: 2px solid #dee2e6;
  }

  .dtrg-group:hover {
    background-color: #f8f9fa !important;
    transform: translateX(2px);
  }

  .dtrg-level-0 {
    background-color: #ffffff !important;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     Estilos de celdas numÃ©ricas
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

  .number-cell {
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  .percent-cell {
    text-align: right;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    padding: 6px 10px !important;
    border-radius: 4px;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     Colores para porcentajes CON FONDO (1T %)
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

  .percent-bg-low {
    background-color: #ff6b6b !important;
    color: white !important;
  }

  .percent-bg-medium {
    background-color: #ffd93d !important;
    color: #333 !important;
  }

  .percent-bg-high {
    background-color: #6bcf7f !important;
    color: white !important;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     Colores para porcentajes SOLO TEXTO (2T % y 3T %)
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

  .percent-text-low {
    color: #ff6b6b !important;
    font-weight: 700;
  }

  .percent-text-medium {
    color: #ff8c00 !important;
    font-weight: 700;
  }

  .percent-text-high {
    color: #28a745 !important;
    font-weight: 700;
  }
</style>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ESTRUCTURA HTML DE LA TARJETA
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div class="card">
  <div class="card-header">
    <h3 class="card-title">
      <i class="fas fa-layer-group mr-2"></i>
      RANKING POR ESTABLECIMIENTO
    </h3>

    <div class="card-tools">
      <button
        type="button"
        class="btn btn-tool btn-sm"
        id="btn-expandir-todo-dt"
        data-toggle="tooltip"
        title="Expandir todos los grupos"
      >
        <i class="fas fa-expand-arrows-alt"></i> Expandir
      </button>

      <button
        type="button"
        class="btn btn-tool btn-sm ml-1"
        id="btn-colapsar-todo-dt"
        data-toggle="tooltip"
        title="Colapsar todos los grupos"
      >
        <i class="fas fa-compress-arrows-alt"></i> Colapsar
      </button>
    </div>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive">
      <table
        id="tabla-variables-detallado"
        class="table table-sm table-hover table-head-fixed text-nowrap"
        style="width: 100%"
      >
        <thead>
          <tr>
            <th>Red</th>
            <th>MicroRed</th>
            <th>Establecimiento</th>
            <th>Den</th>
            <th class="text-center">1Â° Trim</th>
            <th class="text-center">1T %</th>
            <th class="text-center">2Â° Trim</th>
            <th class="text-center">2T %</th>
            <th class="text-center">3Â° Trim</th>
            <th class="text-center">3T %</th>
          </tr>
        </thead>
        <tbody id="tabla-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  (function () {
    "use strict";

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONFIGURACIÃ“N Y CONSTANTES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    const CONFIG = {
      // Umbrales para colores con fondo (1T %) - valores en porcentaje (0-100)
      THRESHOLD_BG: {
        LOW: 70, // < 70% = Rojo
        HIGH: 82, // >= 82% = Verde, entre 70-82 = Amarillo
      },
      // Umbrales para colores de texto (2T % y 3T %) - LÃ³gica inversa
      THRESHOLD_TEXT: {
        LOW: 20, // < 20% = Verde (mejor)
        HIGH: 50, // >= 50% = Rojo, entre 20-50 = Naranja
      },
      // Ãndices de columnas
      COLUMNS: {
        RED: 0,
        MICRORED: 1,
        ESTABLECIMIENTO: 2,
        DENOMINADOR: 3,
        NUM_1T: 4,
        PCT_1T: 5,
        NUM_2T: 6,
        PCT_2T: 7,
        NUM_3T: 8,
        PCT_3T: 9,
        AVG_1T_NUM: 10, // Valor numÃ©rico del porcentaje 1T
        RED_AVG_NUM: 11, // Promedio de RED para ordenamiento
        DEN_RAW: 12, // Denominador raw para cÃ¡lculos
        NUM_1T_RAW: 13, // Numerador 1T raw para cÃ¡lculos
      },
    };

    // Instancia global de la tabla
    let tablaInstance = null;

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FUNCIONES DE UTILIDAD
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    /**
     * Obtiene un valor seguro de un array
     * @param {Array} arr - Array fuente
     * @param {number} index - Ãndice a obtener
     * @param {*} defaultValue - Valor por defecto
     * @returns {*} - Valor obtenido o valor por defecto
     */
    function safeGet(arr, index, defaultValue = "") {
      return arr?.[index] ?? defaultValue;
    }

    /**
     * Convierte un valor a nÃºmero de forma segura
     * @param {*} value - Valor a convertir
     * @param {number} defaultValue - Valor por defecto si no es vÃ¡lido
     * @returns {number} - Valor numÃ©rico
     */
    function toNumber(value, defaultValue = 0) {
      const num = parseFloat(value);
      return isNaN(num) ? defaultValue : num;
    }

    /**
     * Calcula el porcentaje: (numerador / denominador) * 100
     * @param {number} numerador - Valor del numerador
     * @param {number} denominador - Valor del denominador
     * @returns {number} - Porcentaje calculado (0-100)
     */
    function calcularPorcentaje(numerador, denominador) {
      if (denominador === 0 || isNaN(denominador)) return 0;
      return (numerador / denominador) * 100;
    }

    /**
     * Formatea un nÃºmero como porcentaje
     * @param {number} value - Valor numÃ©rico (ya en 0-100)
     * @param {number} decimals - NÃºmero de decimales
     * @returns {string} - Porcentaje formateado
     */
    function formatPercent(value, decimals = 1) {
      if (value == null || isNaN(value)) return "0.0%";
      return value.toFixed(decimals) + "%";
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FUNCIONES DE COLORACIÃ“N
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    /**
     * Extrae el valor numÃ©rico de un string de porcentaje
     * @param {string} cellData - Valor de la celda (ej: "85.5%")
     * @returns {number|null} - Valor numÃ©rico o null
     */
    function extractPercentValue(cellData) {
      if (cellData == null) return null;
      const match = String(cellData).match(/^([\d.]+)/);
      return match ? parseFloat(match[1]) : null;
    }

    /**
     * Aplica colores CON FONDO segÃºn el porcentaje (para 1T %)
     * Mayor porcentaje = Verde (mejor)
     * @param {HTMLElement} td - Celda de la tabla
     * @param {string} cellData - Valor de la celda
     */
    function applyPercentColorWithBackground(td, cellData) {
      const percentValue = extractPercentValue(cellData);
      if (percentValue === null) return;

      const $td = $(td);
      $td.removeClass("percent-bg-low percent-bg-medium percent-bg-high");

      if (percentValue < CONFIG.THRESHOLD_BG.LOW) {
        $td.addClass("percent-bg-low");
      } else if (percentValue < CONFIG.THRESHOLD_BG.HIGH) {
        $td.addClass("percent-bg-medium");
      } else {
        $td.addClass("percent-bg-high");
      }
    }

    /**
     * Aplica colores SOLO TEXTO segÃºn el porcentaje (para 2T % y 3T %)
     * LÃ“GICA INVERSA: Menor porcentaje = Verde (mejor)
     * @param {HTMLElement} td - Celda de la tabla
     * @param {string} cellData - Valor de la celda
     */
    function applyPercentColorTextOnly(td, cellData) {
      const percentValue = extractPercentValue(cellData);
      if (percentValue === null) return;

      const $td = $(td);
      $td.removeClass("percent-text-low percent-text-medium percent-text-high");

      // LÃ³gica inversa: menor es mejor
      if (percentValue < CONFIG.THRESHOLD_TEXT.LOW) {
        $td.addClass("percent-text-high"); // Verde
      } else if (percentValue < CONFIG.THRESHOLD_TEXT.HIGH) {
        $td.addClass("percent-text-medium"); // Naranja
      } else {
        $td.addClass("percent-text-low"); // Rojo
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FUNCIONES DE PROCESAMIENTO DE DATOS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    /**
     * Prepara los datos de la tabla a partir de los datos del backend
     * CÃLCULO: porcentaje = (num_1trim / den_variable) * 100
     * @param {Object} data - Datos del backend
     * @returns {Array} - Datos formateados para DataTables
     */
    function prepareTableData(data) {
      const dataLength = data.d_anio?.length || 0;
      const tableData = [];

      for (let i = 0; i < dataLength; i++) {
        if (!data.d_anio[i]) continue;

        // Obtener valores numÃ©ricos raw
        const denominador = toNumber(safeGet(data.d_den_variable, i, 0));
        const num1trim = toNumber(safeGet(data.d_num_1trim, i, 0));
        const num2trim = toNumber(safeGet(data.d_num_2trim, i, 0));
        const num3trim = toNumber(safeGet(data.d_num_3trim, i, 0));

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CÃLCULO DE PORCENTAJES: (numerador / denominador) * 100
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const avance1trim = calcularPorcentaje(num1trim, denominador);
        const avance2trim = calcularPorcentaje(num2trim, denominador);
        const avance3trim = calcularPorcentaje(num3trim, denominador);

        tableData.push([
          safeGet(data.d_red, i), // 0: Red
          safeGet(data.d_microred, i), // 1: MicroRed
          safeGet(data.d_nombre_establecimiento, i), // 2: Establecimiento
          denominador, // 3: Denominador
          num1trim, // 4: Num 1Â° Trim
          formatPercent(avance1trim), // 5: 1T % (string formateado)
          num2trim, // 6: Num 2Â° Trim
          formatPercent(avance2trim), // 7: 2T % (string formateado)
          num3trim, // 8: Num 3Â° Trim
          formatPercent(avance3trim), // 9: 3T % (string formateado)
          avance1trim, // 10: Valor numÃ©rico 1T% (oculto)
          0, // 11: Promedio RED (se llenarÃ¡ despuÃ©s)
          denominador, // 12: Denominador raw (oculto)
          num1trim, // 13: Num 1T raw (oculto)
        ]);
      }

      return tableData;
    }

    /**
     * Calcula los promedios de 1T% por RED usando suma de numeradores / suma de denominadores
     * FÃ“RMULA: (Î£ num_1trim de RED / Î£ denominador de RED) * 100
     * @param {Array} tableData - Datos de la tabla
     * @returns {Object} - Objeto con estadÃ­sticas por RED
     */
    function calculateAndApplyRedAverages(tableData) {
      const redStats = {};

      // Primera pasada: sumar numeradores y denominadores por RED
      tableData.forEach((row) => {
        const red = row[CONFIG.COLUMNS.RED];
        const denominador = row[CONFIG.COLUMNS.DEN_RAW];
        const numerador = row[CONFIG.COLUMNS.NUM_1T_RAW];

        if (!redStats[red]) {
          redStats[red] = {
            sumNumerador: 0,
            sumDenominador: 0,
            count: 0,
            avgPercent: 0,
          };
        }

        redStats[red].sumNumerador += numerador;
        redStats[red].sumDenominador += denominador;
        redStats[red].count++;
      });

      // Calcular porcentaje promedio por RED
      // FÃ“RMULA: (suma numeradores / suma denominadores) * 100
      Object.keys(redStats).forEach((red) => {
        const stats = redStats[red];
        stats.avgPercent = calcularPorcentaje(
          stats.sumNumerador,
          stats.sumDenominador
        );
      });

      // Segunda pasada: aplicar promedio a cada fila
      tableData.forEach((row) => {
        const red = row[CONFIG.COLUMNS.RED];
        row[CONFIG.COLUMNS.RED_AVG_NUM] = redStats[red].avgPercent;
      });

      console.log("ğŸ“Š EstadÃ­sticas por RED calculadas:");
      Object.keys(redStats).forEach((red) => {
        const s = redStats[red];
        console.log(
          `   RED "${red}": Î£num=${s.sumNumerador}, Î£den=${
            s.sumDenominador
          }, %=${s.avgPercent.toFixed(2)}%`
        );
      });

      return redStats;
    }

    /**
     * Ordena los datos por promedio de RED (desc) y luego por 1T% individual (desc)
     * @param {Array} tableData - Datos de la tabla
     * @returns {Array} - Datos ordenados
     */
    function sortTableData(tableData) {
      return tableData.sort((a, b) => {
        // Primero ordenar por promedio de RED (descendente)
        const redAvgDiff =
          b[CONFIG.COLUMNS.RED_AVG_NUM] - a[CONFIG.COLUMNS.RED_AVG_NUM];
        if (Math.abs(redAvgDiff) > 0.001) {
          return redAvgDiff;
        }
        // Luego ordenar por 1T% individual (descendente)
        return b[CONFIG.COLUMNS.AVG_1T_NUM] - a[CONFIG.COLUMNS.AVG_1T_NUM];
      });
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FUNCIONES DE RENDERIZADO
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    /**
     * Genera el HTML para el encabezado del grupo (RED)
     * La barra de progreso muestra: (Î£ num_1trim / Î£ denominador) * 100
     * @param {Object} rows - Filas del grupo
     * @param {string} group - Nombre del grupo
     * @returns {jQuery} - Elemento TR del grupo
     */
    function renderGroupHeader(rows, group) {
      // Obtener el promedio de la RED desde la primera fila del grupo
      const firstRowData = rows.data()[0];
      const avgPercent = firstRowData[CONFIG.COLUMNS.RED_AVG_NUM];
      const avgPercentFormatted = avgPercent.toFixed(1);
      const rowCount = rows.count();

      // Determinar color de la barra de progreso
      let progressColor = "bg-danger";
      let textColor = "white";

      if (avgPercent >= CONFIG.THRESHOLD_BG.HIGH) {
        progressColor = "bg-success";
      } else if (avgPercent >= CONFIG.THRESHOLD_BG.LOW) {
        progressColor = "bg-warning";
        textColor = "#333";
      }

      // Limitar el ancho de la barra a 100%
      const progressWidth = Math.min(avgPercent, 100);

      const contentHTML = `
        <div class="d-flex justify-content-between align-items-center w-100">
          <!-- InformaciÃ³n del grupo -->
          <div class="d-flex align-items-center">
            <i class="fas fa-plus-circle mr-2 group-toggle-icon"></i>
            <span class="mr-1">RED:</span>
            <strong class="mr-2">${group}</strong>
            <span class="badge badge-secondary">${rowCount} establecimientos</span>
          </div>

          <!-- Barra de progreso con porcentaje calculado -->
          <div class="d-flex align-items-center" style="width: 350px;">
            <small class="text-dark mr-2 text-nowrap"><strong>Promedio 1T:</strong></small>
            <div class="progress flex-fill mx-2" style="height: 22px; background-color: rgba(0,0,0,0.1);">
              <div 
                class="progress-bar ${progressColor}"
                role="progressbar"
                style="width: ${progressWidth}%"
                aria-valuenow="${avgPercentFormatted}"
                aria-valuemin="0"
                aria-valuemax="100"
              >
                <span style="font-size: 12px; font-weight: bold; color: ${textColor};">
                  ${avgPercentFormatted}%
                </span>
              </div>
            </div>
          </div>
        </div>
      `;

      return $("<tr/>")
        .addClass("dtrg-group dtrg-level-0")
        .append($('<td colspan="14">').html(contentHTML))
        .attr("data-group", group)
        .attr("data-level", 0);
    }

    /**
     * Configura las columnas de DataTables
     * @returns {Array} - ConfiguraciÃ³n de columnas
     */
    function getColumnsConfig() {
      return [
        { title: "Red", visible: true }, // 0
        { title: "MicroRed" }, // 1
        { title: "Establecimiento" }, // 2
        { title: "Den", className: "number-cell" }, // 3
        { title: "1Â° Trim", className: "number-cell" }, // 4
        {
          // 5
          title: "1T %",
          className: "percent-cell",
          createdCell: applyPercentColorWithBackground,
        },
        { title: "2Â° Trim", className: "number-cell" }, // 6
        {
          // 7
          title: "2T %",
          className: "percent-cell",
          createdCell: applyPercentColorTextOnly,
        },
        { title: "3Â° Trim", className: "number-cell" }, // 8
        {
          // 9
          title: "3T %",
          className: "percent-cell",
          createdCell: applyPercentColorTextOnly,
        },
        { title: "Avg1T_Num", visible: false, searchable: false }, // 10
        { title: "RedAvg_Num", visible: false, searchable: false }, // 11
        { title: "Den_Raw", visible: false, searchable: false }, // 12
        { title: "Num1T_Raw", visible: false, searchable: false }, // 13
      ];
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FUNCIONES DE EVENTOS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    /**
     * Configura los eventos de la tabla
     */
    function setupTableEvents() {
      const $tableBody = $("#tabla-variables-detallado tbody");

      // Evento click en grupos para expandir/colapsar
      $tableBody
        .off("click", "tr.dtrg-group")
        .on("click", "tr.dtrg-group", function () {
          const $row = $(this);
          const $icon = $row.find(".group-toggle-icon");
          const groupName = $row.attr("data-group");
          const isCollapsing = $icon.hasClass("fa-minus-circle");

          // Alternar icono
          $icon.toggleClass("fa-plus-circle fa-minus-circle");

          // Obtener todas las filas de datos (no grupos) que pertenecen a este grupo
          tablaInstance.rows().every(function () {
            const rowData = this.data();
            if (rowData && rowData[CONFIG.COLUMNS.RED] === groupName) {
              const $node = $(this.node());
              if (!$node.hasClass("dtrg-group")) {
                if (isCollapsing) {
                  $node.hide();
                } else {
                  $node.show();
                }
              }
            }
          });
        });

      // BotÃ³n expandir todo
      $("#btn-expandir-todo-dt")
        .off("click")
        .on("click", function () {
          $("tr.dtrg-group .group-toggle-icon")
            .removeClass("fa-plus-circle")
            .addClass("fa-minus-circle");
          tablaInstance.rows().nodes().to$().show();
        });

      // BotÃ³n colapsar todo
      $("#btn-colapsar-todo-dt")
        .off("click")
        .on("click", function () {
          collapseAllGroups();
        });
    }

    /**
     * Colapsa todos los grupos de la tabla
     */
    function collapseAllGroups() {
      $("tr.dtrg-group .group-toggle-icon")
        .removeClass("fa-minus-circle")
        .addClass("fa-plus-circle");

      tablaInstance
        .rows()
        .nodes()
        .to$()
        .filter(function () {
          return !$(this).hasClass("dtrg-group");
        })
        .hide();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CARGA DE DEPENDENCIAS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    /**
     * Carga la extensiÃ³n RowGroup de DataTables si no estÃ¡ disponible
     * @returns {Promise} - Promesa que se resuelve cuando estÃ¡ cargado
     */
    function loadRowGroupExtension() {
      return new Promise((resolve) => {
        if ($.fn.DataTable?.RowGroup) {
          resolve();
          return;
        }

        // Cargar CSS
        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href =
          "https://cdn.datatables.net/rowgroup/1.4.1/css/rowGroup.bootstrap4.min.css";
        document.head.appendChild(link);

        // Cargar JS
        const script = document.createElement("script");
        script.src =
          "https://cdn.datatables.net/rowgroup/1.4.1/js/dataTables.rowGroup.min.js";
        script.onload = resolve;
        script.onerror = () => {
          console.error("âŒ Error al cargar RowGroup extension");
          resolve();
        };
        document.head.appendChild(script);
      });
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FUNCIÃ“N PRINCIPAL DE RENDERIZADO
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    /**
     * Renderiza la tabla de variables detallado con agrupaciÃ³n
     * @param {Object} data - Datos del backend
     * @param {Object} params - ParÃ¡metros adicionales (opcional)
     */
    window.renderTablaVariablesDetallado = function (data, params) {
      console.log("ğŸ¯ Iniciando renderizado de tabla con agrupaciÃ³n");
      console.log("ğŸ“Š Claves disponibles:", Object.keys(data));

      const dataLength = data.d_anio?.length || 0;
      console.log("ğŸ“ Total de registros:", dataLength);

      // DEBUG: Mostrar muestra de datos para verificar formato
      if (dataLength > 0) {
        console.log("ğŸ” Muestra de datos (primer registro):", {
          red: data.d_red?.[0],
          denominador: data.d_den_variable?.[0],
          num_1trim: data.d_num_1trim?.[0],
          calculo_manual: `(${data.d_num_1trim?.[0]} / ${
            data.d_den_variable?.[0]
          }) * 100 = ${(
            (data.d_num_1trim?.[0] / data.d_den_variable?.[0]) *
            100
          ).toFixed(2)}%`,
        });
      }

      // Validar datos
      if (dataLength === 0) {
        console.warn("âš ï¸ No hay datos para mostrar");
        $("#tabla-variables-detallado tbody").html(
          '<tr><td colspan="10" class="text-center text-muted py-4">' +
            '<i class="fas fa-inbox fa-2x mb-2 d-block"></i>' +
            "No hay datos para mostrar</td></tr>"
        );
        return;
      }

      // Destruir tabla anterior si existe
      if (tablaInstance) {
        tablaInstance.destroy();
        $("#tabla-variables-detallado tbody").empty();
      }

      // PASO 1: Preparar datos (calcula porcentajes como num/den*100)
      const tableData = prepareTableData(data);
      console.log(
        "ğŸ“‹ Datos preparados (primeras 3 filas):",
        tableData.slice(0, 3)
      );

      // PASO 2: Calcular y aplicar promedios por RED (suma_num / suma_den * 100)
      const redStats = calculateAndApplyRedAverages(tableData);

      // PASO 3: Ordenar datos
      const sortedData = sortTableData(tableData);
      console.log(
        "ğŸ“Š Datos ordenados (primeras 3 filas):",
        sortedData.slice(0, 3)
      );

      // PASO 4: Cargar dependencias e inicializar tabla
      loadRowGroupExtension()
        .then(() => {
          initializeDataTable(sortedData);
        })
        .catch((error) => {
          console.error("âŒ Error al inicializar tabla:", error);
        });
    };

    /**
     * Inicializa DataTables con la configuraciÃ³n completa
     * @param {Array} tableData - Datos procesados para la tabla
     */
    function initializeDataTable(tableData) {
      tablaInstance = $("#tabla-variables-detallado").DataTable({
        data: tableData,
        columns: getColumnsConfig(),

        // Deshabilitar ordenamiento automÃ¡tico de DataTables
        // (ya ordenamos manualmente)
        order: [],
        ordering: false,

        // Opciones de visualizaciÃ³n
        paging: false,
        searching: false,
        lengthChange: false,
        info: false,
        responsive: true,
        autoWidth: false,

        // Idioma
        language: {
          emptyTable: "No hay datos disponibles",
          info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
          infoEmpty: "Mostrando 0 registros",
          infoFiltered: "(filtrado de _MAX_ registros)",
        },

        // ConfiguraciÃ³n de grupos
        rowGroup: {
          dataSrc: CONFIG.COLUMNS.RED,
          startRender: renderGroupHeader,
        },
      });

      // Configurar eventos
      setupTableEvents();

      console.log("âœ… Tabla renderizada con Ã©xito");

      // Colapsar automÃ¡ticamente despuÃ©s de un breve delay
      setTimeout(() => {
        collapseAllGroups();
        console.log("ğŸ“ Tabla colapsada automÃ¡ticamente");
      }, 100);
    }
  })();
</script>
