<style>
  #tabla-variables-detallado {
    width: 100% !important;
    font-size: 11px;
  }

  .dataTables_wrapper {
    padding: 0;
  }

  .table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(0, 0, 0, 0.02);
  }

  .dtrg-group {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .dtrg-group:hover {
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%) !important;
    transform: translateX(2px);
  }

  .dtrg-level-0 {
    background: linear-gradient(135deg, #5a67d8 0%, #4c51bf 100%) !important;
  }

  .dtrg-level-1 {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%) !important;
    padding-left: 30px !important;
  }

  .number-cell {
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  .percent-cell {
    text-align: right;
    color: #0066cc;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
  }
</style>

<div class="card shadow-sm border-0">
  <div
    class="card-header bg-white d-flex justify-content-between align-items-center py-3"
  >
    <h6 class="m-0 text-primary font-weight-bold">
      <i class="fas fa-layer-group mr-2"></i>RANKING POR ESTABLECIMIENTO
    </h6>
    <div>
      <button
        class="btn btn-outline-primary btn-sm rounded-pill px-3"
        id="btn-expandir-todo-dt"
      >
        <i class="fas fa-expand-arrows-alt mr-1"></i> Expandir
      </button>
      <button
        class="btn btn-outline-secondary btn-sm rounded-pill px-3 ml-2"
        id="btn-colapsar-todo-dt"
      >
        <i class="fas fa-compress-arrows-alt mr-1"></i> Colapsar
      </button>
    </div>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table
        id="tabla-variables-detallado"
        class="table table-sm table-hover"
        style="width: 100%"
      >
        <thead class="thead-light">
          <tr>
            <th>Red</th>
            <th>MicroRed</th>
            <th>Establecimiento</th>
            <th>Variable</th>
            <th class="text-center">1Â° Trim</th>
            <th class="text-center">1T %</th>
            <th class="text-center">2Â° Trim</th>
            <th class="text-center">2T %</th>
            <th class="text-center">3Â° Trim</th>
            <th class="text-center">3T %</th>
          </tr>
        </thead>
        <tbody id="tabla-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  let tablaInstance = null;

  window.renderTablaVariablesDetallado = function (data, params) {
    console.log("ðŸŽ¯ Renderizando DataTables con agrupaciÃ³n", data);

    const dataLength = data.anio?.length || 0;
    if (dataLength === 0) {
      $("#tabla-variables-detallado tbody").html(
        '<tr><td colspan="10" class="text-center text-muted">No hay datos para mostrar</td></tr>'
      );
      return;
    }

    // Destruir tabla anterior si existe
    if (tablaInstance) {
      tablaInstance.destroy();
      $("#tabla-variables-detallado tbody").empty();
    }

    // Preparar datos
    const tableData = [];
    for (let i = 0; i < dataLength; i++) {
      if (!data.anio[i]) continue;

      tableData.push([
        data.Red?.[i] || "",
        data.MicroRed?.[i] || "",
        data.Nombre_Establecimiento?.[i] || "",
        data.den_variable?.[i] || "",
        data.num_1trim?.[i] || 0,
        data.avance_1trim?.[i] != null
          ? data.avance_1trim[i].toFixed(1) + "%"
          : "0.0%",
        data.num_2trim?.[i] || 0,
        data.avance_2trim?.[i] != null
          ? data.avance_2trim[i].toFixed(1) + "%"
          : "0.0%",
        data.num_3trim?.[i] || 0,
        data.avance_3trim?.[i] != null
          ? data.avance_3trim[i].toFixed(1) + "%"
          : "0.0%",
      ]);
    }

    console.log("ðŸ“Š Filas preparadas:", tableData.length);

    // Cargar RowGroup dinÃ¡micamente si no estÃ¡ cargado
    const loadRowGroup = new Promise((resolve) => {
      if ($.fn.DataTable && $.fn.DataTable.RowGroup) {
        resolve();
      } else {
        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href =
          "https://cdn.datatables.net/rowgroup/1.4.1/css/rowGroup.bootstrap4.min.css";
        document.head.appendChild(link);

        const script = document.createElement("script");
        script.src =
          "https://cdn.datatables.net/rowgroup/1.4.1/js/dataTables.rowGroup.min.js";
        script.onload = resolve;
        document.head.appendChild(script);
      }
    });

    loadRowGroup.then(() => {
      tablaInstance = $("#tabla-variables-detallado").DataTable({
        data: tableData,
        columns: [
          { title: "Red" },
          { title: "MicroRed" },
          { title: "Establecimiento" },
          { title: "Variable" },
          { title: "1Â° Trim", className: "number-cell" },
          { title: "1T %", className: "percent-cell" },
          { title: "2Â° Trim", className: "number-cell" },
          { title: "2T %", className: "percent-cell" },
          { title: "3Â° Trim", className: "number-cell" },
          { title: "3T %", className: "percent-cell" },
        ],
        order: [
          [0, "asc"],
          [1, "asc"],
          [2, "asc"],
        ],
        pageLength: 50,
        searching: false,
        lengthChange: false,
        responsive: true,
        language: {
          info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
          infoEmpty: "Mostrando 0 registros",
          infoFiltered: "(filtrado de _MAX_ registros)",
          paginate: {
            first: "Primero",
            last: "Ãšltimo",
            next: "Siguiente",
            previous: "Anterior",
          },
        },
        rowGroup: {
          dataSrc: [0, 1],
          startRender: function (rows, group, level) {
            const groupLabel = level === 0 ? "RED" : "MICRORED";
            const icon = '<i class="fas fa-plus-circle mr-2"></i>';

            return $("<tr/>")
              .addClass("dtrg-group dtrg-level-" + level)
              .append(
                '<td colspan="10">' +
                  icon +
                  groupLabel +
                  ": <strong>" +
                  group +
                  '</strong> <span class="badge badge-light ml-2">' +
                  rows.count() +
                  "</span></td>"
              )
              .attr("data-group", group)
              .attr("data-level", level);
          },
        },
      });

      // Eventos de expandir/colapsar
      $("#tabla-variables-detallado tbody").on(
        "click",
        "tr.dtrg-group",
        function () {
          const level = parseInt($(this).data("level"));
          const icon = $(this).find("i");

          // Cambiar icono
          if (icon.hasClass("fa-minus-circle")) {
            icon.removeClass("fa-minus-circle").addClass("fa-plus-circle");
          } else {
            icon.removeClass("fa-plus-circle").addClass("fa-minus-circle");
          }

          // Toggle siguiente nivel
          let nextRows = $(this).nextUntil(function () {
            if ($(this).hasClass("dtrg-group")) {
              return parseInt($(this).data("level")) <= level;
            }
            return false;
          });

          nextRows.toggle();
        }
      );

      // Botones
      $("#btn-expandir-todo-dt")
        .off("click")
        .on("click", function () {
          $("tr.dtrg-group").each(function () {
            const icon = $(this).find("i");
            if (icon.hasClass("fa-plus-circle")) {
              $(this).trigger("click");
            }
          });
        });

      $("#btn-colapsar-todo-dt")
        .off("click")
        .on("click", function () {
          $("tr.dtrg-group.dtrg-level-1").each(function () {
            const icon = $(this).find("i");
            if (icon.hasClass("fa-minus-circle")) {
              $(this).trigger("click");
            }
          });
          $("tr.dtrg-group.dtrg-level-0").each(function () {
            const icon = $(this).find("i");
            if (icon.hasClass("fa-minus-circle")) {
              $(this).trigger("click");
            }
          });
        });

      console.log("âœ… DataTables con RowGroup renderizado");

      // Colapsar todo inicialmente - solo mostrar Redes
      setTimeout(() => {
        // Ocultar todas las filas que no sean grupos
        $("#tabla-variables-detallado tbody tr").not(".dtrg-group").hide();

        // Ocultar todos los grupos de MicroRed (nivel 1)
        $("tr.dtrg-group.dtrg-level-1").hide();

        console.log("âœ… Vista inicial colapsada - solo Redes visibles");
      }, 100);
    });
  };
</script>
