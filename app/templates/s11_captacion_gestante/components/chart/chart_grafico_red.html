<script>
  window.renderChartRedRanking = function (data, params) {
    // === VALIDACIONES INICIALES ===
    const container = document.getElementById("chart_red_ranking");

    if (!container) {
      console.error(
        "El contenedor para el ranking de redes no fue encontrado."
      );
      return;
    }

    if (typeof echarts === "undefined") {
      console.error("ECharts no está cargado.");
      return;
    }

    // === INICIALIZACIÓN DEL GRÁFICO ===
    let myChart = echarts.getInstanceByDom(container);
    if (myChart) {
      myChart.dispose();
    }
    myChart = echarts.init(container);

    try {
      // Validar datos de entrada
      if (
        !data?.red_r ||
        !Array.isArray(data.red_r) ||
        data.red_r.length === 0
      ) {
        container.innerHTML =
          '<p class="text-center text-info">No hay datos de redes para mostrar.</p>';
        return;
      }

      // === PROCESAMIENTO DE DATOS ===
      const datosCompletos = data.red_r.map((red, index) => ({
        red: red,
        denominador: data.den_r?.[index] ?? 0,
        numerador: data.num_r?.[index] ?? 0,
        avance: data.avance_r?.[index] ?? 0,
        brecha: data.brecha_r?.[index] ?? 0,
      }));

      // Ordenar por avance descendente
      datosCompletos.sort((a, b) => b.avance - a.avance);

      // Extraer arrays para el gráfico
      const redes = datosCompletos.map((d) => d.red);
      const denominadores = datosCompletos.map((d) => d.denominador);
      const numeradores = datosCompletos.map((d) => d.numerador);
      const avances = datosCompletos.map((d) => d.avance);
      const brechas = datosCompletos.map((d) => d.brecha);

      // === CONFIGURACIÓN DEL GRÁFICO ===
      const option = {
        tooltip: {
          trigger: "axis",
          axisPointer: { type: "shadow" },
          formatter: (params) => {
            let result = `<strong>${params[0].name}</strong><br/>`;

            params.forEach((item) => {
              let valor;
              if (item.seriesName === "Avance") {
                valor = `${parseFloat(item.value).toFixed(2)}%`;
              } else if (item.seriesName === "Brecha") {
                valor = `${item.value} (pendientes)`;
              } else {
                valor = item.value;
              }
              result += `${item.marker} ${item.seriesName}: ${valor}<br/>`;
            });

            return result;
          },
        },

        legend: {
          data: ["Denominador", "Numerador", "Brecha", "Avance"],
        },

        grid: {
          left: "3%",
          right: "4%",
          bottom: "15%",
          containLabel: true,
        },

        xAxis: {
          type: "category",
          data: redes,
          axisPointer: { type: "shadow" },
          axisLabel: {
            rotate: 45,
            interval: 0,
            fontSize: 9,
          },
        },

        yAxis: [
          {
            type: "value",
            name: "Cantidad",
            min: 0,
            axisLabel: { formatter: "{value}" },
          },
          {
            type: "value",
            name: "Avance (%)",
            min: 0,
            max: 100,
            interval: 20,
            axisLabel: { formatter: "{value}%" },
          },
        ],

        series: [
          // Barra del Denominador (columna separada)
          {
            name: "Denominador",
            type: "bar",
            yAxisIndex: 0,
            data: denominadores,
            itemStyle: { color: "#91cc75" }, // Verde
            label: {
              show: true,
              position: "top",
              formatter: "{c}",
              fontSize: 10,
              fontWeight: "bold",
            },
          },
          // Barra del Numerador (columna separada)
          {
            name: "Numerador",
            type: "bar",
            yAxisIndex: 0,
            data: numeradores,
            itemStyle: { color: "#fac858" }, // Amarillo/Naranja
            label: {
              show: true,
              position: "top",
              formatter: "{c}",
              fontSize: 10,
              fontWeight: "bold",
            },
          },
          // Línea punteada para la Brecha
          {
            name: "Brecha",
            type: "line",
            yAxisIndex: 0, // Mismo eje Y que las barras
            data: brechas,
            z: 5,
            symbol: "diamond",
            symbolSize: 10,
            lineStyle: {
              type: "dashed", // Línea punteada
              width: 2,
              color: "#ee6666", // Rojo
            },
            itemStyle: {
              color: "#ee6666",
              borderColor: "#fff",
              borderWidth: 2,
            },
            label: {
              show: true,
              position: "bottom",
              formatter: "{c}",
              fontSize: 9,
              color: "#ee6666",
              fontWeight: "bold",
              backgroundColor: "rgba(255,255,255,0.8)",
              padding: [2, 4],
              borderRadius: 2,
            },
          },
          // Línea de Avance
          {
            name: "Avance",
            type: "line",
            yAxisIndex: 1, // Eje Y secundario (porcentaje)
            data: avances,
            z: 10,
            symbol: "circle",
            symbolSize: 8,
            lineStyle: {
              type: "solid",
              width: 3,
              color: "#5470c6", // Azul
            },
            itemStyle: {
              color: "#5470c6",
              borderColor: "#fff",
              borderWidth: 2,
            },
            label: {
              show: true,
              position: "top",
              formatter: ({ value }) => `${parseFloat(value).toFixed(2)}%`,
              fontSize: 10,
              fontWeight: "bold",
              color: "#5470c6",
            },
            markLine: {
              symbol: "none",
              lineStyle: {
                type: "dashed",
                color: "#ff4d4f",
                width: 2,
              },
              data: [{ yAxis: 85, name: "Meta" }],
              label: {
                show: true,
                formatter: "Meta: 85%",
                position: "end",
                fontWeight: "bold",
              },
            },
          },
        ],
      };

      myChart.setOption(option);

      // Responsive
      window.addEventListener("resize", () => {
        myChart.resize();
      });
    } catch (error) {
      console.error("Error al renderizar el ranking de redes:", error);
      container.innerHTML =
        '<p class="text-center text-danger">Ocurrió un error al cargar el gráfico.</p>';
    }
  };
</script>
