<div class="card">
  <div class="card-header">
    <h3 class="card-title">
      <i class="fas fa-female mr-1"></i>
      N¬∞ GESTANTES CON 1RA APN
    </h3>
    <div class="card-tools">
      <button type="button" class="btn btn-tool" data-card-widget="collapse">
        <i class="fas fa-minus"></i>
      </button>
    </div>
  </div>
  <div class="card-body">
    <div id="chart-trimestre" style="min-height: 250px"></div>
  </div>
</div>

<script>
  window.renderChartAvanceVariables = function (data, params) {
    if (typeof echarts === "undefined") {
      console.error("ECharts no est√° cargado.");
      return;
    }

    const chartDOMElements = {
      trimestre: document.getElementById("chart-trimestre"),
    };

    const charts = {};

    function createOrUpdateChart(chartKey, labels, chartData) {
      const chartDOMElement = chartDOMElements[chartKey];
      if (!chartDOMElement) return;

      let chartInstance = echarts.getInstanceByDom(chartDOMElement);
      if (chartInstance) {
        chartInstance.dispose();
      }
      chartInstance = echarts.init(chartDOMElement);
      charts[chartKey] = chartInstance;

      const option = {
        tooltip: {
          trigger: "axis",
          axisPointer: { type: "shadow" },
          formatter: function (params) {
            const dataItem = params[0].data;
            return `Alcanzado: ${
              dataItem.numerator
            }<br/>Avance: ${dataItem.value.toFixed(1)}%`;
          },
        },
        toolbox: { feature: { saveAsImage: {} } },
        xAxis: {
          type: "category",
          data: labels,
          axisLabel: { rotate: 45, fontSize: 8 },
        },
        yAxis: {
          type: "value",
          max: 100,
          axisLabel: { formatter: "{value}%", fontSize: 8 },
        },
        series: [
          {
            name: "Avance",
            type: "bar",
            data: chartData,
            itemStyle: { color: "#5070dd" },
            label: {
              show: true,
              position: "top",
              formatter: function (params) {
                return params.data.numerator;
              },
              fontSize: 8,
              color: "black",
              fontWeight: "bold",
            },
            markLine: {
              symbol: "none",
              lineStyle: { type: "dashed", color: "red" },
              data: [{ yAxis: 75, name: "M" }],
              label: {
                show: true,
                formatter: `M: 75%`,
                position: "end",
                offset: [0, -14],
                textStyle: { fontSize: 8 },
              },
            },
          },
        ],
      };
      chartInstance.setOption(option);
    }

    try {
      console.log("üìä Datos recibidos en renderChartAvanceVariables:", data);

      // Logs detallados de los datos recibidos
      console.log("üîç Valores brutos recibidos:");
      console.log(
        "  - num_1trim:",
        data.num_1trim,
        "tipo:",
        typeof data.num_1trim,
        "es array:",
        Array.isArray(data.num_1trim)
      );
      console.log(
        "  - num_2trim:",
        data.num_2trim,
        "tipo:",
        typeof data.num_2trim,
        "es array:",
        Array.isArray(data.num_2trim)
      );
      console.log(
        "  - num_3trim:",
        data.num_3trim,
        "tipo:",
        typeof data.num_3trim,
        "es array:",
        Array.isArray(data.num_3trim)
      );
      console.log("  - avance_1trim:", data.avance_1trim);
      console.log("  - avance_2trim:", data.avance_2trim);
      console.log("  - avance_3trim:", data.avance_3trim);

      const extractValue = (rawValue) => {
        if (rawValue == null) return 0;
        // Si es un array, tomar el primer elemento
        const value = Array.isArray(rawValue) ? rawValue[0] : rawValue;
        const numValue = parseFloat(value) || 0;
        return numValue;
      };

      const indicatorGroups = {
        trimestre: [
          {
            title: "1¬∞ TRIM",
            avance_key: "avance_1trim",
            num_key: "num_1trim",
          },
          {
            title: "2¬∞ TRIM",
            avance_key: "avance_2trim",
            num_key: "num_2trim",
          },
          {
            title: "3¬∞ TRIM",
            avance_key: "avance_3trim",
            num_key: "num_3trim",
          },
        ],
      };

      const specialColor = "#505372";

      for (const group in indicatorGroups) {
        const labels = indicatorGroups[group].map((item) => item.title);
        const chartData = indicatorGroups[group].map((item, index) => {
          const value = extractValue(data[item.avance_key]);
          const numerator = extractValue(data[item.num_key]);

          console.log(
            `üìà ${item.title}: numerador=${numerator}, avance=${value}%`
          );

          const dataItem = { value: value, numerator: numerator };
          if (index === 0) {
            dataItem.itemStyle = { color: specialColor };
          }
          if (item.title === "DOSAJE HB" || item.title === "DOSAJE HB") {
            dataItem.itemStyle = { color: "#0ca8df" };
          }
          return dataItem;
        });

        console.log("‚úÖ Datos del gr√°fico procesados:", chartData);
        createOrUpdateChart(group, labels, chartData);
      }
    } catch (error) {
      console.error("‚ùå Error al renderizar los gr√°ficos de variables:", error);
    }

    window.addEventListener("resize", function () {
      for (const key in charts) {
        if (charts[key]) {
          charts[key].resize();
        }
      }
    });
  };
</script>
