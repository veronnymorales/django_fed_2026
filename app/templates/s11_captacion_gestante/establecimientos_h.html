<form method="GET" action="#" id="filter-form">
  <div class="row align-items-end">
    <!-- A√±o -->
    <div class="col-md-1">
      <div class="form-group">
        <label class="text-primary">A√ëO:</label>
        <select
          class="form-control form-control-sm select2"
          id="anio"
          name="anio"
          style="width: 100%"
        >
          <option value="2025" selected>2025</option>
          <option value="2026">2026</option>
        </select>
      </div>
    </div>

    <!-- Mes inicio -->
    <div class="col-md-2">
      <div class="form-group">
        <label class="text-primary">MES INICIO:</label>
        <select
          class="form-control form-control-sm select2"
          id="mes_inicio"
          name="mes_inicio"
          style="width: 50%"
        >
          <option value="1">ENERO</option>
          <option value="2">FEBRERO</option>
          <option value="3">MARZO</option>
          <option value="4">ABRIL</option>
          <option value="5">MAYO</option>
          <option value="6">JUNIO</option>
          <option value="7">JULIO</option>
          <option value="8">AGOSTO</option>
          <option value="9">SETIEMBRE</option>
          <option value="10">OCTUBRE</option>
          <option value="11" selected>NOVIEMBRE</option>
          <option value="12">DICIEMBRE</option>
        </select>
      </div>
    </div>

    <!-- Mes final -->
    <div class="col-md-2">
      <div class="form-group">
        <label class="text-primary">MES FINAL:</label>
        <select
          class="form-control form-control-sm select2"
          id="mes_fin"
          name="mes_fin"
          style="width: 100%"
        >
          <option value="1">ENERO</option>
          <option value="2">FEBRERO</option>
          <option value="3">MARZO</option>
          <option value="4">ABRIL</option>
          <option value="5">MAYO</option>
          <option value="6">JUNIO</option>
          <option value="7">JULIO</option>
          <option value="8">AGOSTO</option>
          <option value="9">SETIEMBRE</option>
          <option value="10">OCTUBRE</option>
          <option value="11" selected>NOVIEMBRE</option>
          <option value="12">DICIEMBRE</option>
        </select>
      </div>
    </div>

    <!-- RED -->
    <div class="col-md-2">
      <div class="form-group">
        <label class="text-primary" for="red_h">REDES:</label>
        <select
          class="form-control form-control-sm select2"
          id="red_h"
          name="red_h"
          hx-get="{% url 'p_microredes_establec_s11_captacion_gestante_h' %}"
          hx-trigger="change"
          hx-target="#container_microredes_establec_h"
          hx-swap="innerHTML"
        >
          <option value="">--- SELECCIONAR ---</option>
          {% for p in redes_h %}
          <option value="{{ p.codigo_red_filtrado }}">{{ p.Red }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- MICRORED -->
    <div class="col-md-2">
      <div class="form-group">
        <label class="text-primary" for="p_microredes_establec_h"
          >MICROREDES:</label
        >
        <div id="container_microredes_establec_h">
          <select
            class="form-control form-control-sm select2"
            id="p_microredes_establec_h"
            name="p_microredes_establec_h"
            hx-get="{% url 'p_establecimientos_s11_captacion_gestante_h' %}"
            hx-trigger="change"
            hx-target="#container_establecimientos_h"
            hx-swap="innerHTML"
            hx-include="[name='red_h']"
            style="width: 100%"
          >
            <option value="">--- SELECCIONAR ---</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ESTABLECIMIENTO -->
    <div class="col-md-2">
      <div class="form-group">
        <label class="text-primary" for="p_establecimiento_h"
          >ESTABLECIMIENTOS:</label
        >
        <div id="container_establecimientos_h">
          <select
            class="form-control form-control-sm select2"
            id="p_establecimiento_h"
            name="p_establecimiento_h"
            style="width: 100%"
          >
            <option value="">--- SELECCIONAR ---</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Botones -->
    <div class="col-md-1">
      <div class="form-group">
        <button type="submit" class="btn btn-primary btn-sm" id="filter-btn">
          <i class="fas fa-filter"></i> Filtrar
        </button>
      </div>
    </div>
  </div>
</form>

<script>
  // Wait for the DOM and all scripts (including jQuery and Select2) to be loaded
  document.addEventListener("DOMContentLoaded", function () {
    // Este script se ejecuta cuando se carga el partial establecimientos_h.html
    (function () {
      // Verificar que jQuery est√° disponible
      if (typeof $ === "undefined") {
        console.error(
          "‚ùå jQuery no est√° cargado. No se puede inicializar Select2."
        );
        return;
      }

      // Inicializar Select2
      $(".select2").select2({
        theme: "bootstrap4",
        width: "100%",
      });

      // Obtener el formulario
      const filterForm = document.getElementById("filter-form");

      // Funci√≥n para enviar el formulario autom√°ticamente
      function autoSubmitForm() {
        if (filterForm) {
          console.log("üì§ Auto-submit disparado");
          filterForm.dispatchEvent(new Event("submit"));
        }
      }

      // Manejar eventos Select2 con HTMX para el select de red
      $("#red_h").on("select2:select", function (e) {
        console.log("üåê Red seleccionada:", e.params.data.text);
        // Disparar manualmente el evento HTMX para asegurar que la petici√≥n se env√≠e
        htmx.trigger(this, "change");

        // Auto-submit despu√©s de que HTMX actualice las microredes
        setTimeout(autoSubmitForm, 300);
      });

      // Auto-submit cuando se selecciona una microred
      $(document).on(
        "select2:select",
        "#p_microredes_establec_h",
        function (e) {
          console.log("ÔøΩ Microred seleccionada:", e.params.data.text);
          // Disparar manualmente el evento HTMX para cargar establecimientos
          htmx.trigger(this, "change");
          // Auto-submit despu√©s de que HTMX actualice los establecimientos
          setTimeout(autoSubmitForm, 300);
        }
      );

      // Auto-submit cuando se selecciona un establecimiento
      $(document).on("select2:select", "#p_establecimiento_h", function (e) {
        console.log("üè® Establecimiento seleccionado:", e.params.data.text);
        autoSubmitForm();
      });

      // Destruir Select2 y LIMPIAR DOM ANTES de que HTMX reemplace el contenido
      document.body.addEventListener("htmx:beforeSwap", function (event) {
        console.log("‚ö° HTMX antes de swap - limpiando Select2");
        const targetElement = event.detail.target;

        // Destruir instancias
        $(targetElement).find(".select2-hidden-accessible").select2("destroy");

        // IMPORTANTE: Vaciar expl√≠citamente el contenedor para evitar duplicados visuales
        targetElement.innerHTML = "";
      });

      // Reinicializar Select2 DESPU√âS de que HTMX haya reemplazado el contenido
      document.body.addEventListener("htmx:afterSwap", function (event) {
        console.log("üîÑ HTMX swap completado - reinicializando Select2");
        const targetElement = event.detail.target;

        // Reinicializar Select2 solo en los elementos nuevos del contenedor
        $(targetElement)
          .find(".select2")
          .each(function () {
            // Verificar si ya est√° inicializado para evitar doble instancia
            if ($(this).hasClass("select2-hidden-accessible")) {
              console.warn("‚ö†Ô∏è Select2 ya estaba inicializado en", this.id);
              return;
            }

            $(this).select2({
              theme: "bootstrap4",
              width: "100%",
              minimumResultsForSearch: -1,
              containerCssClass: "select2-sm",
            });
          });

        // Re-aplicar eventos solo si se actualiz√≥ el contenedor de microredes
        if (targetElement.id === "container_microredes_establec_h") {
          const microredSelect = document.getElementById(
            "p_microredes_establec_h"
          );
          if (microredSelect) {
            console.log("üîó Re-aplicando eventos a microred select");
            // Limpiar eventos previos antes de re-aplicar
            $("#p_microredes_establec_h").off("select2:select");
          }
        }
      });

      // Limpiar formulario - verificar que clear-btn existe
      const clearBtn = document.getElementById("clear-btn");
      if (clearBtn) {
        clearBtn.addEventListener("click", function () {
          console.log("üßπ Limpiando filtros");
          document.getElementById("filter-form").reset();
          $(".select2").val("").trigger("change");
          // Enviar formulario con valores en blanco para resetear el dashboard
          setTimeout(autoSubmitForm, 100);
        });
      } else {
        console.warn("‚ö†Ô∏è Bot√≥n clear-btn no encontrado");
      }
    })();
  });
</script>
